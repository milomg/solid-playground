<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="https://unpkg.com/modern-normalize@1.1.0/modern-normalize.css" rel="stylesheet" />
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.7.0/dist/es-module-shims.js"></script>
    <style>
      html,
      body {
        position: relative;
        width: 100%;
        height: 100%;
      }

      body {
        color: #333;
        margin: 0;
        padding: 8px;
        box-sizing: border-box;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell,
          'Helvetica Neue', sans-serif;
        max-width: 100%;
      }

      .dark body {
        color: #e5e7eb;
      }

      .dark {
        color-scheme: dark;
      }

      input,
      button,
      select,
      textarea {
        padding: 0.4em;
        margin: 0 0 0.5em 0;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 2px;
      }

      button {
        color: #333;
        background-color: #f4f4f4;
        outline: none;
      }

      button:disabled {
        color: #999;
      }

      button:not(:disabled):active {
        background-color: #ddd;
      }

      button:focus {
        border-color: #666;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chobitsu"></script>
    <script src="/lexer.js"></script>
    <script>
      let finisher = undefined;
      let cache = {};
      window.addEventListener('message', ({ data }) => {
        const { event, value } = data;

        if (event == 'CODE_UPDATE') {
          const next = () => {
            window.dispose?.();
            window.dispose = undefined;

            document.getElementById('app').innerHTML = '';

            console.clear();

            document.getElementById('appsrc')?.remove();
            const script = document.createElement('script');
            script.id = 'appsrc';
            script.type = 'module';
            finisher = () => {};
            script.onload = () => {
              if (finisher) finisher();
              finisher = undefined;
            };
            function spliceSlice(str, index, count, add) {
              return str.slice(0, index) + (add || '') + str.slice(index + count);
            }

            function doIt(name, thing) {
              if (cache[name]) return cache[name];

              const [imports, exports] = window.lexerParse(thing);

              cache[name] = 'error:cyclic import';
              for (const imp of imports) {
                if (imp.n.startsWith('.')) {
                  thing = spliceSlice(thing, imp.s, imp.e - imp.s, doIt(imp.n, value[imp.n]));
                }
              }
              const blob = new Blob([thing], { type: 'text/javascript' });
              cache[name] = URL.createObjectURL(blob);

              return cache[name];
            }

            for (const file of Object.values(cache)) {
              URL.revokeObjectURL(file);
            }
            cache = {};
            script.src = doIt('./main', value['./main']);
            document.body.appendChild(script);

            const load = document.getElementById('load');
            if (load) load.remove();
          };
          if (finisher !== undefined) {
            finisher = next;
          } else {
            next();
          }
        } else if (event === 'IMPORT_MAP') {
          const importMap = document.createElement('script');
          importMap.type = 'importmap';
          importMap.innerHTML = JSON.stringify({ imports: value });
          document.head.appendChild(importMap);
        } else if (event === 'DARK') {
          document.documentElement.classList.toggle('dark', value);
        } else if (event === 'DEVTOOLS') {
          sendToDevtools(value);
        } else if (event === 'DEV') {
          chobitsu.sendRawMessage(data.data);
        } else if (event === 'LOADED') {
          sendToDevtools({
            method: 'Page.frameNavigated',
            params: {
              frame: {
                id: '1',
                mimeType: 'text/html',
                securityOrigin: location.origin,
                url: location.href,
              },
              type: 'Navigation',
            },
          });
          sendToChobitsu({ method: 'Network.enable' });
          sendToDevtools({ method: 'Runtime.executionContextsCleared' });
          sendToChobitsu({ method: 'Runtime.enable' });
          sendToChobitsu({ method: 'Debugger.enable' });
          sendToChobitsu({ method: 'DOMStorage.enable' });
          sendToChobitsu({ method: 'DOM.enable' });
          sendToChobitsu({ method: 'CSS.enable' });
          sendToChobitsu({ method: 'Overlay.enable' });
          sendToDevtools({ method: 'DOM.documentUpdated' });
        }
      });

      const sendToDevtools = (message) => {
        window.parent.postMessage(JSON.stringify(message), '*');
      };
      let id = 0;
      const sendToChobitsu = (message) => {
        message.id = 'tmp' + ++id;
        chobitsu.sendRawMessage(JSON.stringify(message));
      };
      chobitsu.setOnMessage((message) => {
        if (message.includes('"id":"tmp')) return;
        window.parent.postMessage(message, '*');
      });
    </script>
  </head>
  <body>
    <div id="load" style="display: flex; height: 80vh; align-items: center; justify-content: center">
      <p style="font-size: 1.5rem">Loading the playground...</p>
    </div>
    <div id="app"></div>
    <script id="appsrc"></script>
  </body>
</html>
